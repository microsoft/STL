# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

# Build STL targeting x86, x64, arm, arm64

variables:
  - template: azure-devops/config.yml

pr:
  drafts: false

stages:
  - stage: Code_Format
    displayName: 'Code Format'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/format-validation.yml

  - stage: Early_Build_x64
    dependsOn: []
    displayName: 'Early Build x64'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x64
          targetArch: x64
          analyzeBuild: true
          buildBenchmarks: true
          doTesting: false
          numShards: 1

  - stage: Early_Build_x86
    dependsOn: []
    displayName: 'Early Build x86'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x86
          targetArch: x86
          analyzeBuild: true
          buildBenchmarks: true
          doTesting: false
          numShards: 1

  - stage: Early_Build_ARM
    dependsOn: []
    displayName: 'Early Build ARM'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x64
          targetArch: arm
          analyzeBuild: true
          doTesting: false
          numShards: 1

  - stage: Early_Build_ARM64
    dependsOn: []
    displayName: 'Early Build ARM64'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x64
          targetArch: arm64
          analyzeBuild: true
          buildBenchmarks: true
          doTesting: false
          numShards: 1

  - stage: Build_And_Test_x64
    dependsOn:
      - Code_Format
      - Early_Build_x64
      - Early_Build_x86
      - Early_Build_ARM
      - Early_Build_ARM64
    displayName: 'Build and Test x64'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x64
          targetArch: x64
          doTesting: true

  - stage: Build_And_Test_x86
    dependsOn: Build_And_Test_x64
    displayName: 'Build and Test x86'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x86
          targetArch: x86
          doTesting: true

  - stage: Build_ARM
    dependsOn: Build_And_Test_x64
    displayName: 'Build ARM'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x64
          targetArch: arm
          cmakeAdditionalFlags: '-DTESTS_BUILD_ONLY=ON'
          doTesting: true

  - stage: Build_ARM64
    dependsOn: Build_And_Test_x64
    displayName: 'Build ARM64'
    pool:
      name: ${{ variables.poolName }}
      demands: ${{ variables.poolDemands }}
    jobs:
      - template: azure-devops/build-and-test.yml
        parameters:
          hostArch: x64
          targetArch: arm64
          cmakeAdditionalFlags: '-DTESTS_BUILD_ONLY=ON'
          doTesting: true
