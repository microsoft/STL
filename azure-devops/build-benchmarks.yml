# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

parameters:
- name: hostArch
  type: string
- name: targetArch
  type: string
- name: targetPlatform
  type: string
- name: buildBenchmarks
  type: boolean
- name: compiler
  type: string

steps:
- task: PowerShell@2
  displayName: 'Configure Benchmarks for ${{ parameters.compiler }}'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      $PSNativeCommandUseErrorActionPreference = $true
      if (Test-Path -LiteralPath "$(benchmarkBuildOutputLocation)\${{ parameters.compiler }}") {
          Remove-Item -LiteralPath "$(benchmarkBuildOutputLocation)\${{ parameters.compiler }}" -Recurse -Force
      }
      & "$(launchVsDevShell)" -HostArch ${{ parameters.hostArch }} -Arch ${{ parameters.targetArch }}
      cmake -G Ninja `
      -DCMAKE_CXX_COMPILER=${{ parameters.compiler }} `
      -DCMAKE_BUILD_TYPE=Release `
      -DSTL_BINARY_DIR="$(buildOutputLocation)" `
      -DVCLIBS_TARGET_ARCHITECTURE=${{ parameters.targetPlatform }} `
      -S $(Build.SourcesDirectory)/benchmarks -B "$(benchmarkBuildOutputLocation)\${{ parameters.compiler }}"
  timeoutInMinutes: 2
  env: { TMP: $(tmpDir), TEMP: $(tmpDir) }
  # TRANSITION, we currently only build the benchmarks with Clang for x64
  condition: >
    and(succeeded(), ${{ parameters.buildBenchmarks }},
      not(and(eq('${{ parameters.compiler }}', 'clang-cl'),
        not(eq('${{ parameters.targetPlatform }}', 'x64')))))
- task: PowerShell@2
  displayName: 'Build Benchmarks for ${{ parameters.compiler }}'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      $PSNativeCommandUseErrorActionPreference = $true
      & "$(launchVsDevShell)" -HostArch ${{ parameters.hostArch }} -Arch ${{ parameters.targetArch }}
      cmake --build "$(benchmarkBuildOutputLocation)\${{ parameters.compiler }}"
  timeoutInMinutes: 2
  env: { TMP: $(tmpDir), TEMP: $(tmpDir) }
  # TRANSITION, we currently only build the benchmarks with Clang for x64
  condition: >
    and(succeeded(), ${{ parameters.buildBenchmarks }},
      not(and(eq('${{ parameters.compiler }}', 'clang-cl'),
        not(eq('${{ parameters.targetPlatform }}', 'x64')))))
