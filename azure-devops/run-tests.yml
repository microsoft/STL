# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

parameters:
- name: hostArch
  type: string
- name: targetArch
  type: string
- name: targetPlatform
  type: string
- name: testTargets
  type: string
- name: runTesting
  type: boolean
steps:
- task: PowerShell@2
  displayName: 'Run Tests'
  inputs:
    pwsh: true
    workingDirectory: $(buildOutputLocation)
    targetType: inline
    script: |
      $PSNativeCommandUseErrorActionPreference = $true
      & "$(launchVsDevShell)" -HostArch ${{ parameters.hostArch }} -Arch ${{ parameters.targetArch }}
      ninja --verbose -k 0 ${{ parameters.testTargets }}
  timeoutInMinutes: 30
  condition: and(succeeded(), ${{ parameters.runTesting }})
  env: { TMP: $(tmpDir), TEMP: $(tmpDir) }
- task: PublishTestResults@2
  displayName: 'Publish Tests'
  timeoutInMinutes: 5
  condition: and(succeededOrFailed(), ${{ parameters.runTesting }})
  inputs:
    searchFolder: $(buildOutputLocation)
    testResultsFormat: JUnit
    testResultsFiles: '**/test-results.xml'
    testRunTitle: 'test-${{ parameters.targetPlatform }}-$(System.JobPositionInPhase)'
- publish: $(buildOutputLocation)/test-results.xml
  artifact: '${{ parameters.targetPlatform }}-$(System.JobPositionInPhase)-xml-$(System.JobId)'
  condition: and(failed(), ${{ parameters.runTesting }})
  displayName: 'Publish XML Artifact'
